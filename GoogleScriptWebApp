/**
 * ESTE CÓDIGO DEBE COPIARSE Y PEGARSE EN GOOGLE APPS SCRIPT
 * DE TU HOJA DE CÁLCULO Y LUEGO SER DESPLEGADO COMO UNA "WEB APP".
 *
 * Configuración de Despliegue CRÍTICA:
 * 1. Clic en "Deploy" (Desplegar) > "New deployment" (Nuevo despliegue).
 * 2. Seleccionar tipo: "Web App".
 * 3. Ejecutar como: "Me" (Tú).
 * 4. ¿Quién tiene acceso?: "Anyone" (Cualquier usuario). <--- ESTO ES CRÍTICO
 * 5. Clic en "Deploy" (Desplegar) y guarda la URL generada.
 * * NOTA DE SOLUCIÓN DE ERRORES: Se ha eliminado la línea output.setHeader() 
 * que causaba el error 'TypeError: output.setHeader is not a function', 
 * ya que no es compatible con ContentService.
 */

// Nombre de la hoja de cálculo donde se almacenarán los datos de los usuarios
const SHEET_NAME = 'User_Data'; 
const HEADERS = ['userId', 'startDateString', 'failedDatesArray'];

/**
 * Función de utilidad para manejar la respuesta JSON.
 */
function jsonResponse(data, code = 200) {
  const output = ContentService.createTextOutput(JSON.stringify(data));
  output.setMimeType(ContentService.MimeType.JSON);
  
  // Hemos quitado la línea output.setHeader('Access-Control-Allow-Origin', '*') que daba error.
  // Google Apps Script maneja CORS automáticamente cuando el despliegue es 'Anyone'.
  
  if (code !== 200) {
    output.setStatusCode(code);
  }
  return output;
}

/**
 * Inicializa la hoja de cálculo y asegura que las cabeceras existan.
 */
function getOrCreateSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAME);
  
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]);
  }
  return sheet;
}

/**
 * Busca una fila por userId y devuelve su índice y datos.
 */
function findUserRow(userId, sheet) {
  const data = sheet.getDataRange().getValues();
  if (data.length <= 1) return { index: -1, data: null };
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId) {
      return { index: i + 1, data: data[i] };
    }
  }
  return { index: -1, data: null };
}

/**
 * Maneja las peticiones GET (principalmente para cargar datos).
 */
function doGet(e) {
  const sheet = getOrCreateSheet();
  const params = e.parameter;
  
  // La respuesta CORS pre-flight solo es necesaria si la cabecera 'Access-Control-Allow-Origin'
  // se incluye manualmente, lo cual ya no hacemos. 
  // No obstante, mantenemos la lógica por si es útil en el futuro.
  if (e.postData && e.postData.type === 'text/plain' && e.postData.contents === 'OPTIONS') {
    return jsonResponse({ status: 'info', message: 'CORS Pre-flight OK' }, 200);
  }
  
  if (params.action === 'load' && params.userId) {
    const userId = params.userId;
    const { index, data } = findUserRow(userId, sheet);
    
    if (index === -1 || !data) {
      return jsonResponse({
        status: 'success',
        message: 'User not found, returning defaults.',
        startDateString: '2025-10-06',
        failedDatesArray: '[]'
      });
    }

    return jsonResponse({
      status: 'success',
      userId: data[0],
      startDateString: data[1],
      failedDatesArray: data[2] || '[]'
    });
  }
  
  return jsonResponse({ 
    status: 'error', 
    message: 'Invalid GET request parameters.' 
  }, 400);
}

/**
 * Maneja las peticiones POST (principalmente para guardar datos).
 */
function doPost(e) {
  try {
    const sheet = getOrCreateSheet();
    const data = JSON.parse(e.postData.contents);
    
    if (data.action === 'save' && data.userId) {
      const userId = data.userId;
      const startDateString = data.startDateString || '2025-10-06';
      const failedDatesArray = data.failedDatesArray || '[]'; 
      
      const { index } = findUserRow(userId, sheet);
      
      const newRow = [
        userId,
        startDateString,
        failedDatesArray
      ];
      
      if (index === -1) {
        sheet.appendRow(newRow);
        return jsonResponse({ status: 'success', message: 'User data saved successfully (new).' });
      } else {
        sheet.getRange(index, 1, 1, newRow.length).setValues([newRow]);
        return jsonResponse({ status: 'success', message: 'User data saved successfully (updated).' });
      }
    }
    
    return jsonResponse({ 
      status: 'error', 
      message: 'Invalid POST request body or action.' 
    }, 400);
  } catch(err) {
    return jsonResponse({ 
      status: 'error', 
      message: `Server-side error: ${err.toString()}` 
    }, 500);
  }
}
